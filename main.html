<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stroop Test Portal</title>
  <style>
    :root{
      --nav:#18314e;
      --accent:#1f7fbf;
      --card-bg: rgba(255,255,255,0.95);
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter, "Segoe UI", Roboto, system-ui, Arial;
      height:100vh; display:flex; flex-direction:column;
      background: linear-gradient(135deg,#9be7ff 0%, #c8d6ff 100%);
      -webkit-font-smoothing:antialiased;
    }

    header.nav{
      position:fixed; top:0; left:0; right:0; height:68px;
      background:var(--nav); color:#fff; display:flex; align-items:center;
      padding:0 22px; z-index:50; box-shadow:0 4px 14px rgba(0,0,0,0.15);
    }
    .brand { font-weight:700; letter-spacing:0.3px; font-size:1.05rem; }
    nav.links { margin-left:auto; display:flex; gap:18px; }
    nav.links button{
      background:transparent; border:none; color: #dbefff; padding:8px 12px;
      cursor:pointer; font-weight:600; border-radius:8px; font-size:0.97rem;
      transition:background .18s, color .18s;
    }
    nav.links button.active, nav.links button:hover{
      background: rgba(255,255,255,0.06);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    }

    main { padding-top:92px; flex:1; overflow:auto; display:flex; justify-content:center; align-items:flex-start; }
    .wrap { width:100%; max-width:1100px; padding:28px; gap:20px; display:flex; flex-direction:column; }
    .card {
      background: var(--card-bg);
      border-radius:14px; padding:22px; box-shadow: 0 10px 30px rgba(19, 46, 74, 0.08);
      border: 1px solid rgba(20,40,70,0.05);
    }

    .home-hero { display:flex; gap:20px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .hero-left { max-width:62%; }
    .hero-left h1 { margin:0; font-size:1.6rem; color:#163147; }
    .hero-left p { margin:10px 0 0; color:#294a63; line-height:1.45; }
    .hero-actions { display:flex; gap:12px; margin-top:14px; }
    .btn { background:var(--accent); color:white; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn.secondary { background:#2b5f86; }
    .btn.ghost { background:transparent; color:var(--nav); border:1px solid rgba(0,0,0,0.06); }

    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; align-items:end; margin-top:12px; }
    label{display:block;font-size:0.9rem;color:#244055;margin-bottom:6px;font-weight:600}
    input[type="text"], input[type="date"]{
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(20,40,70,0.08); font-size:0.95rem;
      background:transparent;
    }
    .center { text-align:center; }
    #gameArea { margin-top:18px; display:none; align-items:center; justify-content:center; flex-direction:column; gap:12px; }

    #levelImage { width:70%; max-width:520px; height:auto; border-radius:12px; border: 3px solid var(--accent); }
    #timerLabel { font-weight:700; font-size:1.1rem; color:#14324b; min-height:22px; }
    #progress { margin-top:6px; font-size:0.95rem; color:#234b63; }

    .controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px; }
    .controls input[type="text"], .controls input[type="date"] { padding:8px 10px; border-radius:8px; border:1px solid rgba(30,60,90,0.07); }
    table.results { width:100%; border-collapse:collapse; margin-top:12px; font-size:0.92rem; }
    table.results th, table.results td { padding:8px 10px; border:1px solid rgba(20,40,70,0.06); text-align:center; }
    table.results th { background:var(--accent); color:#fff; font-weight:700; }
    .small { font-size:0.85rem; color:#1f4154; }

    @media (max-width:880px){
      .hero-left{max-width:100%}
      .form-grid{grid-template-columns:1fr}
      #levelImage{width:92%}
    }
  </style>
</head>
<body>
  <header class="nav">
    <div class="brand">Stroop Test Portal</div>
    <nav class="links">
      <button id="navHome" class="active" onclick="showTab('home')">Home</button>
      <button id="navTest" onclick="showTab('test')">Start Test</button>
      <button id="navAnalysis" onclick="showTab('analysis')">Analysis</button>
      <button id="navAdmin" onclick="showTab('admin')">Admin</button>
    </nav>
  </header>

  <main>
    <div class="wrap">
      <!-- HOME -->
      <section id="home" class="card">
        <div class="home-hero">
          <div class="hero-left">
            <h1>Measure reaction — level by level.</h1>
            <p>
              Start the Stroop test, go through 4 levels, and your timing will be recorded.
              Previous tests are stored and can be downloaded as CSV (columns: name, age, dob, level1, level2, level3, level4, average seconds, total seconds).
            </p>
            <div class="hero-actions">
              <button class="btn" onclick="showTab('test'); focusName()">Start Stroop Test</button>
              <button class="btn secondary" onclick="showTab('analysis'); renderAnalysis()">View Analysis</button>
            </div>
          </div>
          <div class="hero-right center">
            <img src="https://ik.imagekit.io/jpssjscos/IMG-20250917-WA0029.jpg?updatedAt=1758128642301" alt="stroop" style="width:220px;border-radius:12px;border:3px solid rgba(0,0,0,0.06)" />
            <div class="small" style="margin-top:8px">Quick, simple, and single-file — ready for GitHub Pages.</div>
          </div>
        </div>
      </section>

      <!-- TEST -->
      <section id="test" class="card" style="display:none">
        <h2 style="margin:0 0 8px 0">Start Stroop Test</h2>
        <div class="form-grid">
          <div>
            <label for="nameInput">Name</label>
            <input id="nameInput" type="text" placeholder="Enter full name" />
          </div>
          <div>
            <label for="dobInput">Date of Birth</label>
            <input id="dobInput" type="date" max="" />
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
          <button class="btn" id="startBtn" onclick="beginTest()" disabled>Begin Test</button>
          <button class="btn ghost" onclick="resetForm()" style="border:1px solid rgba(0,0,0,0.06); background:transparent; color:var(--nav)">Reset</button>
          <div style="margin-left:auto" class="small">Levels: 4 • Results appended</div>
        </div>

        <div id="gameArea" class="card" style="display:none; margin-top:18px; align-items:center;">
          <div id="progress" class="small"></div>
          <img id="levelImage" src="" alt="Level image" />
          <div id="timerLabel">0.00 s</div>
          <div style="display:flex; gap:10px; margin-top:8px">
            <button class="btn" id="nextBtn" onclick="onNext()">Next</button>
            <button class="btn secondary" onclick="abortTest()">Cancel</button>
          </div>
          <div id="summaryArea" style="margin-top:12px"></div>
        </div>
      </section>

      <!-- ANALYSIS -->
      <section id="analysis" class="card" style="display:none">
        <h2 style="margin:0 0 10px 0">Analysis & Export</h2>

        <div class="controls">
          <input id="filterName" type="text" placeholder="Filter by name..." oninput="renderAnalysis()" />
          <label class="small" style="display:flex; align-items:center; gap:6px;">
            From <input id="fromDate" type="date" onchange="renderAnalysis()" />
          </label>
          <label class="small" style="display:flex; align-items:center; gap:6px;">
            To <input id="toDate" type="date" onchange="renderAnalysis()" />
          </label>
          <button class="btn" onclick="downloadCSVFiltered()">Download CSV (filtered)</button>
          <button class="btn ghost" onclick="clearAll()" style="background:#fff; color:var(--nav); border:1px solid rgba(0,0,0,0.06)">Clear All</button>
        </div>

        <div style="overflow:auto">
          <table class="results" id="resultsTable" >
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Age</th>
                <th>DOB</th>
                <th>Level 1 (s)</th>
                <th>Level 2 (s)</th>
                <th>Level 3 (s)</th>
                <th>Level 4 (s)</th>
                <th>Average (s)</th>
                <th>Total (s)</th>
                <th>Tested On</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="card" style="display:none">
        <h2>Admin: Manage Level Images</h2>
        <div class="form-grid">
          <div><label>Level 1 Image URL</label><input type="text" id="img1Input" placeholder="Enter image URL or base64" /></div>
          <div><label>Level 2 Image URL</label><input type="text" id="img2Input" placeholder="Enter image URL or base64" /></div>
          <div><label>Level 3 Image URL</label><input type="text" id="img3Input" placeholder="Enter image URL or base64" /></div>
          <div><label>Level 4 Image URL</label><input type="text" id="img4Input" placeholder="Enter image URL or base64" /></div>
        </div>
        <button class="btn" onclick="saveImages()">Save Images</button>
        <div id="adminPreview" style="margin-top:12px"></div>
      </section>
    </div>
  </main>

<script>
/* ========================== CONFIG & STORAGE ========================== */
const STORAGE_KEY = 'stroopResults_v1';
const ADMIN_KEY = 'stroopImages_v1';
const IMAGES_DEFAULT = [
  'https://ik.imagekit.io/jpssjscos/Levl1.jpg?updatedAt=1758531189776',
  'https://ik.imagekit.io/jpssjscos/Levl2.jpg?updatedAt=1758460178691',
  'https://ik.imagekit.io/jpssjscos/Levl3.jpg?updatedAt=1758531251550',
  'https://ik.imagekit.io/jpssjscos/Levl4.jpg?updatedAt=1758460239160'
];
let IMAGES = [...IMAGES_DEFAULT];

/* ========================== HELPERS ========================== */
function $(id){return document.getElementById(id);}
function nowISO(){ return new Date().toISOString(); }
function formatReadable(iso){ return new Date(iso).toLocaleString(); }
function csvEscape(s){ if(s===undefined||s===null)return''; const str=String(s); if(str.includes(',')||str.includes('"')||str.includes('\n')) return '"'+str.replace(/"/g,'""')+'"'; return str; }

/* ========================== NAV ========================== */
function showTab(tab){
  ['home','test','analysis','admin'].forEach(t => {const el=$(t); if(el) el.style.display=(t===tab)?'block':'none';});
  ['navHome','navTest','navAnalysis','navAdmin'].forEach(n=>$(n).classList.remove('active'));
  if(tab==='home')$('navHome').classList.add('active');
  if(tab==='test')$('navTest').classList.add('active');
  if(tab==='analysis')$('navAnalysis').classList.add('active');
  if(tab==='admin')$('navAdmin').classList.add('active');
  if(tab==='analysis') renderAnalysis();
  if(tab==='admin') loadAdminImages();
}

/* ========================== AGE ========================== */
function calcAge(dobIso){if(!dobIso)return'';const dob=new Date(dobIso);const t=new Date();let age=t.getFullYear()-dob.getFullYear();const m=t.getMonth()-dob.getMonth();if(m<0||(m===0&&t.getDate()<dob.getDate()))age--;return age;}

/* ========================== STORAGE ========================== */
function readResults(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch(e){return[];}}
function writeResults(list){localStorage.setItem(STORAGE_KEY, JSON.stringify(list||[]));}

/* ========================== TEST STATE ========================== */
let testState = { name:'', dob:'', age:'', times:[], levelIndex:0, levelStartTs:0, timerInterval:null };

/* UI */
const nameInput=$('nameInput'), dobInput=$('dobInput'), startBtn=$('startBtn'), gameArea=$('gameArea');
const levelImage=$('levelImage'), timerLabel=$('timerLabel'), progressLabel=$('progress'), nextBtn=$('nextBtn'), summaryArea=$('summaryArea');

/* initialize DOB max */
dobInput.max = new Date().toISOString().split('T')[0];
[nameInput,dobInput].forEach(el=>el.addEventListener('input',()=>{startBtn.disabled=!(nameInput.value.trim()&&dobInput.value);}))

function focusName(){ setTimeout(()=>nameInput.focus(),120); }

/* ========================== TEST FLOW ========================== */
function beginTest(){
  testState.name=nameInput.value.trim();
  testState.dob=dobInput.value;
  testState.age=calcAge(testState.dob);
  testState.times=[];
  testState.levelIndex=0;
  summaryArea.innerHTML='';
  gameArea.style.display='flex';
  loadLevel(0);
}

function loadLevel(idx){
  testState.levelIndex=idx;
  const totalLevels=IMAGES.length;
  levelImage.src=IMAGES[idx];
  progressLabel.textContent=`Level ${idx+1} of ${totalLevels}`;
  timerLabel.textContent='0.00 s';
  testState.levelStartTs=0;
  if(testState.timerInterval){ clearInterval(testState.timerInterval); testState.timerInterval=null; }
  nextBtn.disabled=true;
  summaryArea.innerHTML=`<button class="btn" onclick="startLevel()">Start Level</button>`;
}

function startLevel(){
  testState.levelStartTs=Date.now();
  summaryArea.innerHTML=`<button class="btn secondary" onclick="endLevel()">End Level</button>`;
  testState.timerInterval=setInterval(()=>{timerLabel.textContent=((Date.now()-testState.levelStartTs)/1000).toFixed(2)+' s';},50);
}

function endLevel(){
  if(!testState.levelStartTs)return;
  const timeTaken=((Date.now()-testState.levelStartTs)/1000);
  testState.times.push(timeTaken.toFixed(2));
  clearInterval(testState.timerInterval);
  testState.timerInterval=null;
  summaryArea.innerHTML='';
  nextBtn.disabled=false;
}

function onNext(){
  if(testState.levelIndex<IMAGES.length-1) loadLevel(testState.levelIndex+1);
  else finishTest();
}

function abortTest(){ if(confirm('Cancel this test? Current partial data will be discarded.')){ if(testState.timerInterval) clearInterval(testState.timerInterval); gameArea.style.display='none'; summaryArea.innerHTML=''; testState={name:'',dob:'',age:'',times:[],levelIndex:0,levelStartTs:0,timerInterval:null}; } }

function finishTest(){
  const times=testState.times.map(t=>parseFloat(t));
  const total=times.reduce((a,b)=>a+b,0);
  const avg=total/times.length;
  const iso=nowISO();
  const entry={ name:testState.name, age:testState.age, dob:testState.dob, times:times.map(t=>t.toFixed(2)), average:avg.toFixed(2), total:total.toFixed(2), testedOn:iso };
  const list=readResults(); list.push(entry); writeResults(list);
  alert('Test completed! Times recorded.');
  gameArea.style.display='none';
  startBtn.disabled=true;
  renderAnalysis();
}

/* ========================== ADMIN ========================== */
function loadAdminImages(){
  const saved=JSON.parse(localStorage.getItem(ADMIN_KEY)||'[]');
  if(saved.length===4) IMAGES.splice(0,4,...saved);
  ['img1Input','img2Input','img3Input','img4Input'].forEach((id,i)=>$(id).value=IMAGES[i]||'');
  renderAdminPreview();
}

function saveImages(){
  const newImgs=['img1Input','img2Input','img3Input','img4Input'].map(id=>$(id).value.trim());
  if(newImgs.some(i=>!i)){ alert('All 4 images are required'); return; }
  localStorage.setItem(ADMIN_KEY,JSON.stringify(newImgs));
  IMAGES.splice(0,4,...newImgs);
  alert('Images saved successfully!');
  renderAdminPreview();
}

function renderAdminPreview(){
  const preview=$('adminPreview'); preview.innerHTML='';
  IMAGES.forEach(src=>{
    const img=document.createElement('img'); img.src=src;
    img.style.width='120px'; img.style.margin='4px'; img.style.border='2px solid var(--accent)'; img.style.borderRadius='8px';
    preview.appendChild(img);
  });
}

/* ========================== ANALYSIS ========================== */
function renderAnalysis(){
  const tbody=$('resultsBody'); tbody.innerHTML='';
  const list=readResults();
  const filterName=$('filterName').value.toLowerCase(), fromD=$('fromDate').value, toD=$('toDate').value;
  const filtered=list.filter(e=>{
    let pass=true;
    if(filterName) pass=pass && e.name.toLowerCase().includes(filterName);
    if(fromD) pass=pass && (new Date(e.testedOn)>=new Date(fromD));
    if(toD) pass=pass && (new Date(e.testedOn)<=new Date(toD+'T23:59:59'));
    return pass;
  });
  filtered.forEach((e,i)=>{
    const tr=document.createElement('tr');
    const levelCols=e.times.map(t=>`<td>${t}</td>`).join('');
    tr.innerHTML=`<td>${i+1}</td><td>${e.name}</td><td>${e.age}</td><td>${e.dob}</td>${levelCols}<td>${e.average}</td><td>${e.total}</td><td>${formatReadable(e.testedOn)}</td><td><button class="btn ghost" onclick="deleteEntry(${i})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function deleteEntry(idx){
  if(confirm('Delete this entry?')){
    const list=readResults(); list.splice(idx,1); writeResults(list); renderAnalysis();
  }
}

function clearAll(){ if(confirm('Clear all results?')){ localStorage.removeItem(STORAGE_KEY); renderAnalysis(); } }

function downloadCSVFiltered(){
  const list=readResults();
  const filterName=$('filterName').value.toLowerCase(), fromD=$('fromDate').value, toD=$('toDate').value;
  const filtered=list.filter(e=>{
    let pass=true;
    if(filterName) pass=pass && e.name.toLowerCase().includes(filterName);
    if(fromD) pass=pass && (new Date(e.testedOn)>=new Date(fromD));
    if(toD) pass=pass && (new Date(e.testedOn)<=new Date(toD+'T23:59:59'));
    return pass;
  });
  let csv='Name,Age,DOB,Level1,Level2,Level3,Level4,Average,Total,TestedOn\n';
  filtered.forEach(e=>{
    csv+=[e.name,e.age,e.dob,...e.times,e.average,e.total,e.testedOn].map(csvEscape).join(',')+'\n';
  });
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='stroop_filtered.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* ========================== INIT ========================== */
document.addEventListener('DOMContentLoaded',()=>{
  showTab('home');
  renderAnalysis();
  loadAdminImages();
});
</script>
</body>
</html>
