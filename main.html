<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stroop Test Portal</title>
  <style>
    :root {
      --nav:#18314e;
      --accent:#1f7fbf;
      --card-bg: rgba(255,255,255,0.95);
    }
    body {
      margin:0; font-family:Inter,Arial; background:linear-gradient(135deg,#9be7ff 0%, #c8d6ff 100%);
      height:100vh; display:flex; flex-direction:column;
    }
    header.nav {
      position:fixed; top:0; left:0; right:0; height:68px;
      background:var(--nav); color:#fff; display:flex; align-items:center;
      padding:0 22px; z-index:50;
    }
    .brand { font-weight:700; font-size:1.1rem; }
    nav.links { margin-left:auto; display:flex; gap:14px; }
    nav.links button { background:transparent; border:none; color:#dbefff; padding:8px 12px;
      cursor:pointer; border-radius:8px; font-weight:600; }
    nav.links button.active, nav.links button:hover { background:rgba(255,255,255,0.1); color:#fff; }
    main { padding-top:88px; flex:1; display:flex; justify-content:center; }
    .wrap { width:100%; max-width:1100px; padding:20px; }
    .card { background:var(--card-bg); padding:20px; border-radius:12px; margin-bottom:16px; }
    h2 { margin-top:0; }
    .btn { background:var(--accent); color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn.secondary { background:#2b5f86; }
    .btn.ghost { background:#fff; color:var(--nav); border:1px solid #ccc; }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    table th, table td { border:1px solid #ccc; padding:6px 8px; text-align:center; }
    table th { background:var(--accent); color:#fff; }
    .small { font-size:0.85rem; color:#123; }
    .level-row { display:flex; gap:8px; margin-bottom:8px; }
    .level-row input { flex:1; padding:6px; border-radius:6px; border:1px solid #ccc; }
  </style>
</head>
<body>
  <header class="nav">
    <div class="brand">Stroop Test Portal</div>
    <nav class="links">
      <button id="navHome" onclick="showTab('home')">Home</button>
      <button id="navTest" onclick="showTab('test')">Test</button>
      <button id="navAnalysis" onclick="showTab('analysis')">Analysis</button>
      <button id="navAdmin" onclick="showTab('admin')">Admin</button>
    </nav>
  </header>

  <main>
    <div class="wrap">
      <!-- HOME -->
      <section id="home" class="card">
        <h2>Welcome</h2>
        <p>Run a Stroop Test with flexible levels defined by the Admin.</p>
      </section>

      <!-- TEST -->
      <section id="test" class="card" style="display:none">
        <h2>Start Stroop Test</h2>
        <label>Name: <input id="nameInput" type="text" /></label>
        <label>Date of Birth: <input id="dobInput" type="date" max="" /></label>
        <br><br>
        <button class="btn" id="startBtn" onclick="beginTest()" disabled>Begin Test</button>

        <div id="gameArea" style="display:none; margin-top:20px;">
          <div id="progress" class="small"></div>
          <h3 id="levelTitle"></h3>
          <img id="levelImage" src="" style="max-width:420px; border:3px solid var(--accent); border-radius:10px" />
          <div id="timerLabel" style="font-size:1.2rem; margin-top:10px;">0.00 s</div>
          <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
            <button class="btn secondary" onclick="startTimer()">Start</button>
            <button class="btn" onclick="endTimer()">End</button>
            <button class="btn ghost" onclick="onNext()">Next</button>
          </div>
          <div id="summaryArea" style="margin-top:14px"></div>
        </div>
      </section>

      <!-- ANALYSIS -->
      <section id="analysis" class="card" style="display:none">
        <h2>Results</h2>
        <button class="btn" onclick="downloadCSV()">Download CSV</button>
        <table id="resultsTable">
          <thead><tr id="resultsHead"></tr></thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </section>

      <!-- ADMIN -->
      <section id="admin" class="card" style="display:none">
        <h2>Admin Panel</h2>
        <div id="levelsContainer"></div>
        <button class="btn" onclick="addLevel()">+ Add Level</button>
        <button class="btn secondary" onclick="saveLevels()">Save Levels</button>
      </section>
    </div>
  </main>

<script>
const STORAGE_KEY = 'stroopResults_v2';
const LEVELS_KEY = 'stroopLevels_v2';

function $(id){return document.getElementById(id);}
function showTab(tab){
  ['home','test','analysis','admin'].forEach(t=>$(t).style.display=(t===tab)?'block':'none');
  document.querySelectorAll("nav.links button").forEach(b=>b.classList.remove("active"));
  document.getElementById("nav"+tab[0].toUpperCase()+tab.slice(1)).classList.add("active");
  if(tab==='analysis') renderAnalysis();
  if(tab==='admin') renderAdmin();
}

// Age calc
function calcAge(dob){
  if(!dob) return '';
  const d=new Date(dob), t=new Date();
  let age=t.getFullYear()-d.getFullYear();
  if(t.getMonth()<d.getMonth()||(t.getMonth()===d.getMonth()&&t.getDate()<d.getDate())) age--;
  return age;
}

// Storage helpers
function readResults(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }
function writeResults(list){ localStorage.setItem(STORAGE_KEY,JSON.stringify(list)); }
function readLevels(){ return JSON.parse(localStorage.getItem(LEVELS_KEY)||'[]'); }
function writeLevels(list){ localStorage.setItem(LEVELS_KEY,JSON.stringify(list)); }

// Test flow
let testState={name:'',dob:'',age:'',times:[],idx:0,startTs:0,timer:null,levels:[]};

$('dobInput').max=new Date().toISOString().split('T')[0];
$('nameInput').addEventListener('input',checkReady);
$('dobInput').addEventListener('input',checkReady);
function checkReady(){ $('startBtn').disabled=!( $('nameInput').value && $('dobInput').value ); }

function beginTest(){
  testState.name=$('nameInput').value.trim();
  testState.dob=$('dobInput').value;
  testState.age=calcAge(testState.dob);
  testState.times=[];
  testState.idx=0;

  // Get levels from localStorage, if not available, fall back to default
  let savedLevels = readLevels();
  if (savedLevels.length === 0) {
    savedLevels = [
      { name: "Level 1", url: "https://ik.imagekit.io/vukmjukgtm/Level%201%20?updatedAt=1758875505209" },
      { name: "Level 2", url: "https://ik.imagekit.io/vukmjukgtm/Level%202?updatedAt=1758875663145" },
      { name: "Level 3", url: "https://ik.imagekit.io/vukmjukgtm/Level%203?updatedAt=1758875723492" },
      { name: "Level 4 (a)", url: "https://ik.imagekit.io/vukmjukgtm/Level%204%20(a)?updatedAt=1758875953822" },
      { name: "Level 4 (b)", url: "https://ik.imagekit.io/vukmjukgtm/Level%204%20(b)?updatedAt=1758876000194" }
    ];
  }
  testState.levels = savedLevels;

  $('gameArea').style.display='block';
  loadLevel(0);
}
function loadLevel(i){
  testState.idx=i;
  const lvl=testState.levels[i];
  $('progress').textContent=`Level ${i+1} of ${testState.levels.length}`;
  $('levelTitle').textContent=lvl.name;
  $('levelImage').src=lvl.url;
  $('timerLabel').textContent="0.00 s";
  testState.startTs=0;
  if(testState.timer) clearInterval(testState.timer);
}
function startTimer(){
  testState.startTs=Date.now();
  if(testState.timer) clearInterval(testState.timer);
  testState.timer=setInterval(()=>{
    $('timerLabel').textContent=((Date.now()-testState.startTs)/1000).toFixed(2)+" s";
  },50);
}
function endTimer(){
  if(!testState.startTs) return;
  const t=((Date.now()-testState.startTs)/1000).toFixed(2);
  testState.times.push(t);
  clearInterval(testState.timer);
  $('timerLabel').textContent=t+" s (recorded)";
}
function onNext(){
  if(testState.idx<testState.levels.length-1){
    loadLevel(testState.idx+1);
  } else {
    finishTest();
  }
}
function finishTest(){
  const total=testState.times.reduce((a,b)=>a+parseFloat(b),0);
  const avg=total/testState.times.length;
  const entry={name:testState.name,age:testState.age,dob:testState.dob,times:testState.times,total:total.toFixed(2),average:avg.toFixed(2),testedAt:new Date().toISOString()};
  const all=readResults(); all.push(entry); writeResults(all);
  $('summaryArea').innerHTML=`<b>Done!</b> Total: ${entry.total}s, Avg: ${entry.average}s`;
  renderAnalysis(); showTab('analysis');
}

// Analysis


function renderAnalysis(){
  const all = readResults();
  let lvls = readLevels();

  // fallback if no levels saved
  if (lvls.length === 0) {
    lvls = [
      { name: "Level 1", url: "" },
      { name: "Level 2", url: "" },
      { name: "Level 3", url: "" },
      { name: "Level 4 (a)", url: "" },
      { name: "Level 4 (b)", url: "" }
    ];
  }

  // Table header
  const headRow = $('resultsHead');
  headRow.innerHTML = "<th>#</th><th>Name</th><th>Age</th><th>DOB</th>";
  lvls.forEach((l,i) => {
    headRow.innerHTML += `<th>${l.name} (s)</th>`;
  });
  headRow.innerHTML += "<th>Average (s)</th><th>Total (s)</th><th>Tested On</th>";

  // Table body
  const body = $('resultsBody');
  body.innerHTML = '';
  all.forEach((r,i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${i+1}</td><td>${r.name}</td><td>${r.age}</td><td>${r.dob}</td>`;

    // each level time
    lvls.forEach((l,j) => {
      tr.innerHTML += `<td>${r.times[j] ? r.times[j] + " s" : "-"}</td>`;
    });

    // average + total
    tr.innerHTML += `<td>${r.average} s</td><td>${r.total} s</td><td>${new Date(r.testedAt).toLocaleString()}</td>`;
    body.appendChild(tr);
  });
}

// CSV
function downloadCSV(){
  const all=readResults(); const lvls=readLevels();
  if(all.length===0){alert("No results");return;}
  let header=["name","age","dob"]; lvls.forEach(l=>header.push(l.name)); header.push("average","total","testedAt");
  let rows=[header.join(",")];
  all.forEach(r=>{
    let row=[r.name,r.age,r.dob]; lvls.forEach((l,i)=>row.push(r.times[i]||"")); row.push(r.average,r.total,r.testedAt); rows.push(row.join(","));
  });
  const blob=new Blob([rows.join("\n")],{type:"text/csv"}); const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="stroop_results.csv"; a.click(); URL.revokeObjectURL(url);
}

// Admin
function renderAdmin(){
  const cont=$('levelsContainer'); cont.innerHTML='';
  const lvls=readLevels();
  lvls.forEach((l,i)=>{
    const div=document.createElement('div'); div.className="level-row";
    div.innerHTML=`<input type="text" value="${l.name}" placeholder="Level Name" onchange="updateLevel(${i},'name',this.value)" />
                   <input type="text" value="${l.url}" placeholder="Image URL" onchange="updateLevel(${i},'url',this.value)" />
                   <button class="btn ghost" onclick="removeLevel(${i})">X</button>`;
    cont.appendChild(div);
  });
}
function addLevel(){ const lvls=readLevels(); lvls.push({name:"New Level",url:""}); writeLevels(lvls); renderAdmin(); }
function updateLevel(i,field,val){ const lvls=readLevels(); lvls[i][field]=val; writeLevels(lvls); }
function removeLevel(i){ const lvls=readLevels(); lvls.splice(i,1); writeLevels(lvls); renderAdmin(); }
function saveLevels(){ alert("Levels saved!"); }
document.addEventListener('DOMContentLoaded',()=>{showTab('home');});
</script>
</body>
</html>
